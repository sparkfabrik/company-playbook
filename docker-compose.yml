version: "3"
services:
  documentation:
    build:
      context: .
      target: dev
    environment:
      - VIRTUAL_HOST=playbook.sparkfabrik.loc
    volumes:
      - ./assets:/opt/raneto/assets
      - ./content:/opt/raneto/content
      - ./custom/config.js:/opt/raneto/config.js
      - ./custom/themes:/opt/raneto/themes
      - ./custom/node_modules:/opt/raneto/node_modules
    labels:
      com.dnsdock.alias: playbook.sparkfabrik.loc
      
  chromadb:
    image: chromadb/chroma:latest
    volumes:
      - chromadb:/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma
      - ANONYMIZED_TELEMETRY=FALSE
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"]
    ports:
      - ${CHROMADB_PORT:-8000}:8000

  # api:
  #   hostname: api
  #   build:
  #     context: ./services
  #     dockerfile: api/Dockerfile
  #   environment:
  #     - VIRTUAL_HOST=api.playbook.sparkfabrik.loc
  #   profiles: ["api"]
  #   volumes:
  #     - ./services/api:$PWD
  #     - ./.local:/home/node/.local
  #   user: node
  #   working_dir: $PWD
  #   labels:
  #     com.dnsdock.alias: api.playbook.sparkfabrik.loc
  api:
    hostname: api
    build:
      context: ./services
      dockerfile: Dockerfile
    volumes:
      - ./services:/usr/src/app
      # - ./.local:/home/node/.local
    # user: node
    working_dir: /usr/src/app
    entrypoint: /usr/src/app/entrypoint.sh
    environment:
      - VIRTUAL_HOST=api.sparkfabrik.loc
    labels:
      com.dnsdock.alias: api.sparkfabrik.loc
    command: "npx tsx api.ts"

  cli:
    hostname: sparkathon
    build:
      context: .
      dockerfile: services/node/Dockerfile
      target: cli
    profiles: ["cli"]
    environment:
      - HISTFILE=/home/node/.local/.bash_history
      - NPM_CONFIG_CACHE=/home/node/.local/.npm-cache
      - CHROMADB_PORT=${CHROMADB_PORT:-8000}
    volumes:
      - $PWD:$PWD
      - ./.local:/home/node/.local
    user: node
    working_dir: $PWD
    network_mode: host
    command: /bin/sh -c "while sleep 1000; do :; done"


volumes:
  chromadb:
